name: On-demand IPK Build

on:
  issue_comment:
    types: [created]

env:
  REGISTRY: ghcr.io
  SDK_VERSION: 24.10.5
  SDK_ARCH: x86-64

jobs:
  build-ipk:
    if: |
      github.event.issue.pull_request && 
      contains(github.event.comment.body, '/build-ipk') &&
      (github.event.comment.author_association == 'OWNER' || github.event.comment.author_association == 'COLLABORATOR' || github.event.comment.author_association == 'MEMBER')

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      packages: read

    steps:
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.issue.number }}/head

      - name: Export Project Variables
        run: |
          grep '^PKG_.*:=' Makefile | sed 's/:=/=/' >> $GITHUB_ENV

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker Images
        continue-on-error: true
        run: |
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          REPO_NAME=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_BASE="$REGISTRY/$REPO_OWNER/$REPO_NAME"

          docker pull $IMAGE_BASE/builder:latest || true
          docker pull $IMAGE_BASE/tester:latest || true

          docker tag $IMAGE_BASE/builder:latest ${{ env.PKG_NAME }}-builder:${{ env.SDK_ARCH }}-${{ env.SDK_VERSION }} || true
          docker tag $IMAGE_BASE/tester:latest ${{ env.PKG_NAME }}-tester:${{ env.SDK_ARCH }}-${{ env.SDK_VERSION }} || true

      - name: Post Starting Comment
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = process.env.GITHUB_SERVER_URL + '/' + process.env.GITHUB_REPOSITORY + '/actions/runs/' + process.env.GITHUB_RUN_ID;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üöÄ **IPK Build Started!**\n\nI am compiling `' + process.env.PKG_NAME + '`. This might take a few minutes. You can track the progress [here](' + runUrl + '). I will post an update once it is finished.'
            })

      - name: Build IPK package
        run: make -f dev.mk package

      - name: Upload IPK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PKG_NAME }}-pr-${{ github.event.issue.number }}
          path: bin/packages/*/base/${{ env.PKG_NAME }}*.ipk

      - name: Post Success Comment
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = process.env.GITHUB_SERVER_URL + '/' + process.env.GITHUB_REPOSITORY + '/actions/runs/' + process.env.GITHUB_RUN_ID;
            const pkgName = process.env.PKG_NAME;
            const bt = String.fromCharCode(96);
            const body = '‚úÖ **IPK Build Succeeded for ' + pkgName + '!**\n\n' +
                         'You can download the build artifact (contained in a **.zip** file) from the [Actions Summary Page](' + runUrl + ').\n\n' +
                         '### How to install:\n' +
                         '1. Download and extract the **.zip** file to get the **.ipk**.\n' +
                         '2. Transfer the **.ipk** to your OpenWrt device (e.g., using ' + bt + 'scp' + bt + ').\n' +
                         '3. Install it using ' + bt + 'opkg' + bt + ':\n' +
                         '   ' + bt + bt + bt + 'bash\n' +
                         '   opkg update\n' +
                         '   opkg install /path/to/' + pkgName + '_*.ipk\n' +
                         '   ' + bt + bt + bt + '\n\n' +
                         '*Note: opkg will automatically resolve and install dependencies from the official repositories.*';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })

      - name: Post Failure Comment
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = process.env.GITHUB_SERVER_URL + '/' + process.env.GITHUB_REPOSITORY + '/actions/runs/' + process.env.GITHUB_RUN_ID;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **IPK Build Failed!**\n\nSomething went wrong during the compilation of `' + process.env.PKG_NAME + '`. You can check the error logs [here](' + runUrl + ').'
            })
