name: CI Pipeline

on:
  push:
    branches: [main, master]
    tags: ["v*"]
    paths-ignore:
      - "**.md"
      - ".gitignore"
      - "LICENSE"
      - ".vscode/**"
  pull_request:
    branches: [main, master]
    paths-ignore:
      - "**.md"
      - ".gitignore"
      - "LICENSE"
      - ".vscode/**"

env:
  REGISTRY: ghcr.io
  SDK_VERSION: 24.10.5
  SDK_ARCH: x86-64

jobs:
  check-changes:
    name: Check for Environment Changes
    runs-on: ubuntu-latest
    outputs:
      build_env: ${{ steps.filter.outputs.build_env }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Path Filter
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            build_env:
              - 'Dockerfile*'

  build-images:
    name: Build & Publish Images
    needs: check-changes
    if: needs.check-changes.outputs.build_env == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Export Project Variables
        run: |
          grep '^PKG_NAME:=' Makefile | sed 's/:=/=/' >> $GITHUB_ENV
          echo "PKG_DEPENDS=$(grep 'DEPENDS:=' Makefile | cut -d= -f2 | tr -d '+')" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Builder
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') }}
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ github.event.repository.name }}/builder:latest
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ github.event.repository.name }}/builder:${{ env.SDK_ARCH }}-${{ env.SDK_VERSION }}
          build-args: |
            SDK_ARCH=${{ env.SDK_ARCH }}
            SDK_VERSION=${{ env.SDK_VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Tester
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.dev
          push: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') }}
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ github.event.repository.name }}/tester:latest
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ github.event.repository.name }}/tester:${{ env.SDK_ARCH }}-${{ env.SDK_VERSION }}
          build-args: |
            SDK_ARCH=${{ env.SDK_ARCH }}
            SDK_VERSION=${{ env.SDK_VERSION }}
            PKG_DEPENDS=${{ env.PKG_DEPENDS }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  test:
    name: Run Unit Tests
    needs: [check-changes, build-images]
    # Run if check-changes succeeded AND (build-images succeeded OR was skipped)
    if: |
      always() &&
      needs.check-changes.result == 'success' &&
      (needs.build-images.result == 'success' || needs.build-images.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Export Project Variables
        run: |
          grep '^PKG_NAME:=' Makefile | sed 's/:=/=/' >> $GITHUB_ENV

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker Images
        continue-on-error: true
        run: |
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          REPO_NAME=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_BASE="$REGISTRY/$REPO_OWNER/$REPO_NAME"

          docker pull $IMAGE_BASE/builder:${{ env.SDK_ARCH }}-${{ env.SDK_VERSION }} || docker pull $IMAGE_BASE/builder:latest || true
          docker pull $IMAGE_BASE/tester:${{ env.SDK_ARCH }}-${{ env.SDK_VERSION }} || docker pull $IMAGE_BASE/tester:latest || true

          docker tag $IMAGE_BASE/builder:${{ env.SDK_ARCH }}-${{ env.SDK_VERSION }} ${{ env.PKG_NAME }}-builder:${{ env.SDK_ARCH }}-${{ env.SDK_VERSION }} || \
          docker tag $IMAGE_BASE/builder:latest ${{ env.PKG_NAME }}-builder:${{ env.SDK_ARCH }}-${{ env.SDK_VERSION }} || true

          docker tag $IMAGE_BASE/tester:${{ env.SDK_ARCH }}-${{ env.SDK_VERSION }} ${{ env.PKG_NAME }}-tester:${{ env.SDK_ARCH }}-${{ env.SDK_VERSION }} || \
          docker tag $IMAGE_BASE/tester:latest ${{ env.PKG_NAME }}-tester:${{ env.SDK_ARCH }}-${{ env.SDK_VERSION }} || true

      - name: Run tests
        run: make -f dev.mk test VERBOSE=1

  release:
    name: Build & Release IPK
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Export Project Variables
        run: |
          grep '^PKG_NAME:=' Makefile | sed 's/:=/=/' >> $GITHUB_ENV

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker Images
        run: |
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          REPO_NAME=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_BASE="$REGISTRY/$REPO_OWNER/$REPO_NAME"
          docker pull $IMAGE_BASE/builder:${{ env.SDK_ARCH }}-${{ env.SDK_VERSION }}
          docker tag $IMAGE_BASE/builder:${{ env.SDK_ARCH }}-${{ env.SDK_VERSION }} ${{ env.PKG_NAME }}-builder:${{ env.SDK_ARCH }}-${{ env.SDK_VERSION }}

      - name: Build IPK package
        run: make -f dev.mk package

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: bin/packages/*/base/${{ env.PKG_NAME }}*.ipk
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
